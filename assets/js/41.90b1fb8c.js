(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{331:function(t,a,s){"use strict";s.r(a);var n=s(10),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"advanced-series-developing-the-heir-module-prototype"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#advanced-series-developing-the-heir-module-prototype"}},[t._v("#")]),t._v(" Advanced Series â€” Developing the Heir Module Prototype")]),t._v(" "),a("h2",{attrs:{id:"heir-module-development"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heir-module-development"}},[t._v("#")]),t._v(" Heir Module Development")]),t._v(" "),a("p",[t._v("Having finished an overview of the Antara development layout, we are now prepared to create a simplified prototype of the "),a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-api/heir.html#introduction"}},[t._v("Heir Module")]),t._v(".")],1),t._v(" "),a("h4",{attrs:{id:"links-to-heir-source-code-and-building-instructions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#links-to-heir-source-code-and-building-instructions"}},[t._v("#")]),t._v(" Links to Heir Source Code and Building Instructions")]),t._v(" "),a("p",[t._v("A complete working example of this simplified Heir Antara module tutorial can be found at the following link. We invite the reader to download and review the final code while progressing through the tutorial.")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/dimxy/komodo/tree/heir-simple",target:"_blank",rel:"noopener noreferrer"}},[t._v("Link to Simplified Heir Module"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("The source files are found in the following directories.")]),t._v(" "),a("ul",[a("li",[t._v("src/cc/heir.cpp")]),t._v(" "),a("li",[t._v("src/cc/CCheir.h")]),t._v(" "),a("li",[t._v("src/wallet/rpcwallet.cpp")]),t._v(" "),a("li",[t._v("src/rpc/server.cpp")]),t._v(" "),a("li",[t._v("src/rpc/server.h")])]),t._v(" "),a("h4",{attrs:{id:"downloading-and-installing-from-source"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#downloading-and-installing-from-source"}},[t._v("#")]),t._v(" Downloading and Installing From Source")]),t._v(" "),a("p",[t._v("At this time, the reader will need to have the Komodo Smart Chain source code available. The reader begins with this default source code and adds to it to create a new Antara Module.")]),t._v(" "),a("p",[t._v("Instructions to download and build Komodo software is found here.")]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/basic-docs/smart-chains/smart-chain-setup/installing-from-source.html#linux"}},[t._v("Link to Instructions for Building from Source")])],1),t._v(" "),a("h2",{attrs:{id:"begin-development"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#begin-development"}},[t._v("#")]),t._v(" Begin Development")]),t._v(" "),a("p",[t._v("Our tasks are the following:")]),t._v(" "),a("ul",[a("li",[t._v("Add a new "),a("code",[t._v("EVAL")]),t._v(" code to represent this module")]),t._v(" "),a("li",[t._v("Create a global CC address")]),t._v(" "),a("li",[t._v("Define the Heir Module transactions\n"),a("ul",[a("li",[t._v("vouts, or logical conditions")]),t._v(" "),a("li",[t._v("vins, or logical fulfillments")])])]),t._v(" "),a("li",[t._v("Implement the RPC interface")]),t._v(" "),a("li",[t._v("Create the validation code")])]),t._v(" "),a("h2",{attrs:{id:"create-the-eval-code"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-the-eval-code"}},[t._v("#")]),t._v(" Create the EVAL Code")]),t._v(" "),a("p",[t._v("In a previous section of this advanced series, we discussed the nature of creating a new EVAL code for an Antara Module.")]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-tutorials/advanced-series-2.html#the-eval-code"}},[a("b",[t._v("Link to EVAL code instructions here.")])])],1),t._v(" "),a("p",[t._v("Review the above linked section and attempt to create an EVAL code on your own for this simplified Heir Module.")]),t._v(" "),a("p",[t._v("When you are finished with your attempt, compare your results with the downloadable files for this tutorial.")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/dimxy/komodo/blob/heir-simple/src/cc/eval.h",target:"_blank",rel:"noopener noreferrer"}},[a("b",[t._v("Link to EVAL code source file in simplified Heir Module downloadables.")]),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"global-cc-address"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#global-cc-address"}},[t._v("#")]),t._v(" Global CC Address")]),t._v(" "),a("p",[t._v("We also recently discussed the method of adding a Global CryptoCondition (CC) Address as a part of initiating a new Antara Module.")]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-tutorials/advanced-series-2.html#creating-a-global-cc-address"}},[a("b",[t._v("Link to Global CC Address instructions here.")])])],1),t._v(" "),a("p",[t._v("Review the above linked section and attempt to create a Global CC Address on your own.")]),t._v(" "),a("p",[t._v("When you are finished with your attempt, compare your results with the downloadable files for this tutorial.")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/dimxy/komodo/blob/heir-simple/src/cc/CCcustom.cpp",target:"_blank",rel:"noopener noreferrer"}},[a("b",[t._v("Link to Global CC Address file in simplified Heir Module downloadables.")]),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"heir-module-transactions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heir-module-transactions"}},[t._v("#")]),t._v(" Heir Module Transactions")]),t._v(" "),a("p",[t._v("We require three types of module transactions")]),t._v(" "),a("ul",[a("li",[t._v("an initial transaction with which a user creates the fund for inheritance")]),t._v(" "),a("li",[t._v("a transaction for additional funding")]),t._v(" "),a("li",[t._v("a transaction for spending funds by the owner or heir")])]),t._v(" "),a("h4",{attrs:{id:"the-initial-transaction-creating-a-fund"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-initial-transaction-creating-a-fund"}},[t._v("#")]),t._v(" The Initial Transaction: Creating a Fund")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Input/Output")]),t._v(" "),a("th",[t._v("Description")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("vins.*")])]),t._v(" "),a("td",[a("b",[t._v("Normal input")]),t._v(" "),a("br"),t._v(" - The "),a("code",[t._v("*")]),t._v(" notation implies that this can apply to any number of inputs "),a("br"),t._v(" - These vins are typical of core blockchain software and not related to CC")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vout.0")])]),t._v(" "),a("td",[a("b",[t._v("The "),a("code",[t._v("1of2")]),t._v(" CC address that holds the funds that belong to the owner and, once available, to the heir")])])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vout.1")])]),t._v(" "),a("td",[a("b",[t._v("The transaction fee to account for the "),a("code",[t._v("vout.0")]),t._v(" amount above")]),t._v(" "),a("br"),t._v(" - The amount in "),a("code",[t._v("vout.1")]),t._v(" is used as a marker. We will discuss markers and their uses cases further on in the tutorial")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vout.2")])]),t._v(" "),a("td",[a("b",[t._v("Normal change")]),t._v(" "),a("br"),t._v(" - Recall that "),a("code",[t._v("change")]),t._v(" is the leftover amount from the original utxo that the user does not intend to send to the destination address, and which the user desires to keep "),a("br"),t._v(" - Any amount of leftover funds not included in the "),a("code",[t._v("change")]),t._v(" utxo is forfeited to the miner of the block; this is how miners receive their mining fee")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vout.n-1")])]),t._v(" "),a("td",[a("b",[t._v("OP_RETURN EVAL_HEIR 'F' ownerpk heirpk inactivitytime heirname")]),t._v(" "),a("br"),t._v(" - This is the is the opreturn vout, and it contains any data relevant to the module "),a("br"),t._v(" - The 'F' is a flag that indicates that this transaction is a \"Funding\" CC transaction "),a("br"),t._v(" - "),a("code",[t._v("ownerpk")]),t._v(" and "),a("code",[t._v("heirpk")]),t._v(" respectively represent the pubkeys of the owner and heir "),a("br"),t._v(" - Concerning "),a("code",[t._v("inactivitytime")]),t._v(", the owner should either make a donation to or spend from the "),a("code",[t._v("1of2")]),t._v(" address within the "),a("code",[t._v("inactivitytime")]),t._v(" amount of time to prevent opening the "),a("code",[t._v("1of2")]),t._v(" address to the heir for spending. "),a("br"),t._v(" - "),a("code",[t._v("heirname")]),t._v(" is the name of this instance of the Heir Module")])])])]),t._v(" "),a("p",[t._v('Through a funding transaction, the owner of the initial funds creates a "plan," which we can also call a "module data instance," and deposits funds for future spending.')]),t._v(" "),a("p",[t._v("The initial funds are taken from normal utxos. The initial transaction spends these normal utxos and uses them to create an CC-related utxo. Thus, the initial transaction is the beginning of the relationship between the funds and the Heir Antara Module.")]),t._v(" "),a("p",[t._v("The main funds for the plan are allocated to "),a("code",[t._v("vout.0")]),t._v(" of our CC transaction.")]),t._v(" "),a("p",[t._v("By design, and setting aside issues of timing, we desire that either the owner or the inheritor of the funds should be able to spend this utxo. We assume that the owner has one address, and the inheritor has another. To achieve this, we use an advanced CryptoConditions feature that states that either of two addresses can spend the funds. This is called a "),a("code",[t._v("1of2")]),t._v(" CryptoCondition, and it is placed as a logical condition into "),a("code",[t._v("vout.0")]),t._v(".")]),t._v(" "),a("p",[t._v("A fee is allocated to "),a("code",[t._v("vout.1")]),t._v(". This is used as a marker. The marker allows a developer to use a special SDK function, "),a("code",[t._v("SetCCunspents()")]),t._v(", to create a list of all initial transactions for the module.")]),t._v(" "),a("p",[t._v("As usual, out of the remaining amount of our initial utxo, we need to send all that we desire to keep to our "),a("code",[t._v("change")]),t._v(" address.")]),t._v(" "),a("p",[t._v("Also, we need to leave an amount as an incentive for the miner. Any remainder beyond the sum total of our new "),a("code",[t._v("vout")]),t._v(" values will automatically be allocated in this manner. We typically leave "),a("code",[t._v("10000")]),t._v(" satoshis of our Smart Chain coin, by convention.")]),t._v(" "),a("p",[t._v("Note the "),a("code",[t._v("F")]),t._v(" letter in the opreturn structure. The "),a("code",[t._v("F")]),t._v(' stands for "fund." By convention, the first byte of any opreturn is the '),a("code",[t._v("EVAL")]),t._v(" code. The second byte is the transaction functional id, we use it to understand the transaction data structure in the opreturn.")]),t._v(" "),a("p",[t._v("We also stored other relevant data in the opreturn:")]),t._v(" "),a("ul",[a("li",[t._v("The owner and inheritor pubkeys")]),t._v(" "),a("li",[t._v("Inactivity time\n"),a("ul",[a("li",[t._v("this is the amount of seconds during which the owner must exhibit activity to maintain sole control over the funds")]),t._v(" "),a("li",[t._v("If the owner does not spend funds during this time period, the inheritor will gain the ability to spend these funds as well")])])]),t._v(" "),a("li",[t._v("The descriptive name of this funding plan")])]),t._v(" "),a("h4",{attrs:{id:"the-add-coins-transaction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-add-coins-transaction"}},[t._v("#")]),t._v(" The Add Coins Transaction")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Input/Output")]),t._v(" "),a("th",[t._v("Description")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("vins.*")])]),t._v(" "),a("td",[t._v("normal inputs")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vout.0")])]),t._v(" "),a("td",[t._v("the funding CC "),a("code",[t._v("1of2")]),t._v(" address for the owner and heir. This address consists of two parts: the owner and heir pubkeys. Either owner or heir can spend this vout")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vout.1")])]),t._v(" "),a("td",[t._v("normal change")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vout.n-1")])]),t._v(" "),a("td",[t._v("OP_RETURN 'A' fundingtxid HasHeirSpendingBegun")])])])]),t._v(" "),a("p",[t._v("This transaction serves the purpose of adding more funds to the owner's address. The transaction uses normal coin inputs (non-CC) and sends them to the CC "),a("code",[t._v("1of2")]),t._v(" address.")]),t._v(" "),a("p",[t._v("We include the transaction id (txid) of the initial transaction in the opreturn to bind the add transaction to the plan.")]),t._v(" "),a("p",[t._v("Note the functional id, "),a("code",[t._v("A")]),t._v(". This flag indicates that this transaction is an "),a("code",[t._v("add")]),t._v(" type of funding transaction.")]),t._v(" "),a("p",[t._v("Note the "),a("code",[t._v("HasHeirSpendingBegun")]),t._v(" flag as well. This is discussed later in the series, in the module source-code description.")]),t._v(" "),a("h4",{attrs:{id:"the-claim-coins-transaction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-claim-coins-transaction"}},[t._v("#")]),t._v(" The Claim Coins Transaction")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("input/output")]),t._v(" "),a("th",[t._v("description")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("vin.0")]),t._v(" "),a("td",[t._v("normal input transaction fee")])]),t._v(" "),a("tr",[a("td",[t._v("vin.1+")]),t._v(" "),a("td",[t._v("input from CC "),a("code",[t._v("1of2")]),t._v(" address")])]),t._v(" "),a("tr",[a("td",[t._v("vout.0")]),t._v(" "),a("td",[t._v("normal output, sent to the owner or the heir address")])]),t._v(" "),a("tr",[a("td",[t._v("vout.1")]),t._v(" "),a("td",[a("code",[t._v("change")]),t._v(" to CC "),a("code",[t._v("1of2")]),t._v(" address")])]),t._v(" "),a("tr",[a("td",[t._v("vout.2")]),t._v(" "),a("td",[a("code",[t._v("change")]),t._v(" to user's address from transaction fee input, if any")])]),t._v(" "),a("tr",[a("td",[t._v("vout.n-1")]),t._v(" "),a("td",[t._v("OP_RETURN EVAL_HEIR 'C' fundingtxid HasHeirSpendingBegun")])])])]),t._v(" "),a("p",[t._v("This transaction allows either the owner or the heir to spend funds from this plan instance.")]),t._v(" "),a("p",[t._v("To pay the transaction fee to the miners, the transaction has a normal input that draws from the wallet of the transaction creator.")]),t._v(" "),a("p",[t._v("The transaction also has a CC input for spending the claimed value from the "),a("code",[t._v("1of2")]),t._v(" fund address.")]),t._v(" "),a("p",[t._v('As for outputs, the claimed value is sent to the claimer\'s normal address, allowing the claimer to spend funds as usual. Unspent or leftover "change" from the transaction is returned to the '),a("code",[t._v("1of2")]),t._v(" address.")]),t._v(" "),a("p",[t._v("We also indicate the normal "),a("code",[t._v("change")]),t._v(".")]),t._v(" "),a("p",[t._v("The functional id, "),a("code",[t._v("C")]),t._v(', in the opreturn indicates that this is a "claim" type transaction.')]),t._v(" "),a("p",[t._v("We also include all the same opreturn data as in the "),a("code",[t._v("A")]),t._v(" transaction, include the "),a("code",[t._v("fundingtxid")]),t._v(" and the "),a("code",[t._v("HasHeirSpendingBegun")]),t._v(" flag.")]),t._v(" "),a("h2",{attrs:{id:"heir-module-rpc-implementations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heir-module-rpc-implementations"}},[t._v("#")]),t._v(" Heir Module RPC Implementations")]),t._v(" "),a("h4",{attrs:{id:"heirfund"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heirfund"}},[t._v("#")]),t._v(" heirfund")]),t._v(" "),a("p",[t._v("For a user to call the "),a("code",[t._v("heirfund")]),t._v(" RPC, the user will need to supply the name of the RPC and its parameters as arguments.")]),t._v(" "),a("p",[t._v("We model the syntax as follows:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("./komodo-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-ac_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("YOURCHAIN heirfund amount name heirpubkey inactivitytime\n")])])]),a("h5",{attrs:{id:"descriptions-of-the-heirfund-syntax"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#descriptions-of-the-heirfund-syntax"}},[t._v("#")]),t._v(" Descriptions of the heirfund Syntax")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Argument")]),t._v(" "),a("th",[t._v("Type")]),t._v(" "),a("th",[t._v("Description")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("amount")]),t._v(" "),a("td",[t._v("(number)")]),t._v(" "),a("td",[t._v("The initial funding amount, in coins")])]),t._v(" "),a("tr",[a("td",[t._v("name")]),t._v(" "),a("td",[t._v("(string)")]),t._v(" "),a("td",[t._v("The name of the heir funding plan (arbitrary)")])]),t._v(" "),a("tr",[a("td",[t._v("heirpubkey")]),t._v(" "),a("td",[t._v("(string)")]),t._v(" "),a("td",[t._v("The heir's public key (in hexademical)")])]),t._v(" "),a("tr",[a("td",[t._v("inactivitytime")]),t._v(" "),a("td",[t._v("(number)")]),t._v(" "),a("td",[t._v("The time (in seconds) that must pass without the owner executing an "),a("code",[t._v("heiradd")]),t._v(" or "),a("code",[t._v("heirclaim")]),t._v(" method, after which the address unlocks to the heir")])])])]),t._v(" "),a("h4",{attrs:{id:"adding-the-command-to-the-source-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#adding-the-command-to-the-source-file"}},[t._v("#")]),t._v(" Adding the Command to the Source File")]),t._v(" "),a("p",[t._v("To add a new command to "),a("code",[t._v("komodo-cli")]),t._v(" we open the "),a("code",[t._v("src/server.cpp")]),t._v(" source file add a new element to the "),a("code",[t._v("vRPCCommands")]),t._v(" array.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"heir"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"heirfund"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("heirfund"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("Object")]),t._v(" "),a("th",[t._v("Description")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("heir")]),t._v(" "),a("td",[t._v("a common name for all heir module RPC calls")])]),t._v(" "),a("tr",[a("td",[t._v("heirfund")]),t._v(" "),a("td",[t._v("the name of the new command")])]),t._v(" "),a("tr",[a("td",[t._v("&heirfund")]),t._v(" "),a("td",[t._v("the address of the RPC interface function")])]),t._v(" "),a("tr",[a("td",[t._v("true")]),t._v(" "),a("td",[t._v("indicates that the command description will be shown in the help command output; placing "),a("code",[t._v("false")]),t._v(" here would hide this RPC from the help output")])])])]),t._v(" "),a("h4",{attrs:{id:"add-the-rpc-function-declaration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-the-rpc-function-declaration"}},[t._v("#")]),t._v(" Add the RPC Function Declaration")]),t._v(" "),a("p",[t._v("We add the RPC function declaration in the "),a("code",[t._v("rpc/server.h")]),t._v(" source file.")]),t._v(" "),a("p",[t._v("The declaration in this file is essentially the same across all RPC functions.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("UniValue "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("heirfund")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" UniValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" fHelp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"the-two-levels-of-an-rpc-implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-two-levels-of-an-rpc-implementation"}},[t._v("#")]),t._v(" The Two Levels of an RPC Implementation")]),t._v(" "),a("p",[t._v("There are two levels to an RPC implementation.")]),t._v(" "),a("p",[t._v("The first level is a short RPC function that has the same name as the RPC command itself (such as "),a("code",[t._v("heirfund")]),t._v(").")]),t._v(" "),a("p",[t._v("The body of this level is added to a source file in the "),a("code",[t._v("rpc/")]),t._v(" subdirectory in the source code (for this example, we added the RPC functions for Heir Module in the wallet/rpcwallet.cpp).")]),t._v(" "),a("p",[t._v("Creating a new RPC source file for each Antara Module's RPC functions is considered a best practice.")]),t._v(" "),a("p",[t._v("This function checks the RPC parameters and the needed environment, and then forwards the RPC to the second level.")]),t._v(" "),a("p",[t._v("To begin the RPC command, we declare the "),a("code",[t._v("heirfund")]),t._v(" function and clear the global error object.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// heirfund command rpc-level implementation, src/wallet/rpcwallet.cpp")]),t._v("\nUniValue "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("heirfund")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" UniValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" fHelp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    CCerror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clear")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// clear global error object")]),t._v("\n")])])]),a("p",[t._v("Recall that a Smart Chain must have the "),a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-setup/antara-customizations.html#ac-cc"}},[a("b",[t._v("ac_cc")])]),t._v(" and "),a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-setup/antara-customizations.html#ac-ccenable"}},[a("b",[t._v("ac_ccenable")])]),t._v(" customization parameters properly initiated for any Antara Module to function.")],1),t._v(" "),a("p",[t._v("Therefore, we check that the wallet and Heir Module features are available in the Smart Chain. We also check the RPC parameter's required number:")]),t._v(" "),a("p",[t._v("Ensure that the wallet object is initialized:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("EnsureWalletIsAvailable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fHelp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" NullUniValue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Ensure that the chain parameters needed for Antara Modules are correctly set. For example, "),a("RouterLink",{attrs:{to:"/basic-docs/smart-chains/smart-chain-setup/common-runtime-parameters.html#addressindex"}},[a("b",[t._v("addressindex")])]),t._v(" and "),a("RouterLink",{attrs:{to:"/basic-docs/smart-chains/smart-chain-setup/common-runtime-parameters.html#spentindex"}},[a("b",[t._v("spentindex")])]),t._v(" should both be enabled. Also, ensure that the Heir Module is enabled on this chain.")],1),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ensure_CCrequirements")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("runtime_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"to use Antara modules, you need to launch daemon with valid -pubkey= for an address in your wallet\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// output help message if asked or params count is incorrect:")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fHelp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("runtime_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"heirfund funds heirname heirpubkey inactivitytime\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Lock the user's wallet:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LOCK2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cs_main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pwalletMain"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("cs_wallet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("The "),a("code",[t._v("UniValue")]),t._v(" object is a special type used to pass data in RPC calls. The "),a("code",[t._v("UniValue")]),t._v(" object is native to all blockchains based on the Bitcoin protocol. For parameters, UniValue requires an array of UniValue objects.")]),t._v(" "),a("p",[t._v("We must convert these UniValue objects into normal C/C++ language types, and then pass them to the second level of our module implementation.")]),t._v(" "),a("p",[t._v("Convert the parameters from the UniValue type to their basic C++ types and add checks to ensure that the converted parameter values are correct.")]),t._v(" "),a("p",[t._v("This content is abbreviated. "),a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-tutorials/heir-module-tutorial.html#links-to-heir-source-code-and-building-instructions"}},[t._v("For links to the full source code and example files, click here.")])],1),t._v(" "),a("p",[t._v("Note the method for parsing the hex representation of the pubkey parameter and converting it to a "),a("code",[t._v("CPubKey")]),t._v(" object.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    CAmount amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("atof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("c_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" COIN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Note conversion from satoshis to coins through a multiplication of 10E8")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("runtime_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"amount cant be negative"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("string name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" vheirpubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ParseHex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("c_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CPubKey heirpk "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("pubkey2pk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vheirpubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" inactivitytime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("atoll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("c_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Finally, call the Heir Module code, pass our values (now in C++ type format), and set these as the value of the final "),a("code",[t._v("result")]),t._v(" object. Bear in mind that the returned value from the Heir Module code, "),a("code",[t._v("HeirFund")]),t._v(", returns a hexadecimal value.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    UniValue result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HeirFund")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirpk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inactivitytime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("RETURN_IF_ERROR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CCerror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use a macro to throw runtime_error if CCerror is set in HeirFund()")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("a",{attrs:{href:"https://github.com/dimxy/komodo/blob/heir-simple/src/wallet/rpcwallet.cpp#L7740",target:"_blank",rel:"noopener noreferrer"}},[t._v("See the linked source code (line number is approximate.)"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"second-level-implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#second-level-implementation"}},[t._v("#")]),t._v(" Second Level Implementation")]),t._v(" "),a("p",[t._v("The second level of the RPC implementation is the transaction creation code. This resides in the "),a("code",[t._v("src/cc/heir.cpp")]),t._v(" source file.")]),t._v(" "),a("h4",{attrs:{id:"implementing-heirfund-transaction-creation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#implementing-heirfund-transaction-creation"}},[t._v("#")]),t._v(" Implementing heirfund transaction creation")]),t._v(" "),a("p",[t._v("The following content displays the skeleton of the "),a("b",[t._v("heirfund")]),t._v(" RPC implementation.")]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-tutorials/heir-module-tutorial.html#links-to-heir-source-code-and-building-instructions"}},[t._v("For links to the full source code and example files, click here.")])],1),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// heirfund transaction creation code, src/cc/heir.cpp")]),t._v("\nstd"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("string "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HeirFund")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("string heirName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CPubKey heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" inactivityTimeSec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("Create a mutable version of a transaction object.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    CMutableTransaction mtx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CreateNewContextualCMutableTransaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Params")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetConsensus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("komodo_nextheight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Declare and initialize an "),a("code",[t._v("CCcontract_info")]),t._v(" object with Heir Module variables, such as our global CC address, our global private key, etc.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CCcontract_info")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    cp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CCinit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h4",{attrs:{id:"adding-inputs-to-the-transaction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#adding-inputs-to-the-transaction"}},[t._v("#")]),t._v(" Adding Inputs to the Transaction")]),t._v(" "),a("p",[t._v("Add inputs to the transaction that are enough to make a deposit of the requested amount to the Heir fund. Also add one fee to serve as a marker, and another for the miners.")]),t._v(" "),a("p",[t._v("By tradition, we use a constant fee of "),a("code",[t._v("10000")]),t._v(" satoshis.")]),t._v(" "),a("p",[t._v("We use the "),a("code",[t._v("pubkey")]),t._v(" from the komodod "),a("code",[t._v("-pubkey")]),t._v(" launch parameter as the destination address for the funds withdrawn from the "),a("code",[t._v("1of2")]),t._v(" plan address.")]),t._v(" "),a("p",[t._v("We use a function in the CC SDK, "),a("code",[t._v("AddNormalinputs")]),t._v(", to add the normal inputs to the mutable transaction.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" txfee "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CPubKey myPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("pubkey2pk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Mypubkey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddNormalinputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" myPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("txfee "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("The parameters passed to the "),a("code",[t._v("AddNormalinputs()")]),t._v(" function are:")]),t._v(" "),a("ul",[a("li",[t._v("The transaction itself")]),t._v(" "),a("li",[t._v("The user's pub")]),t._v(" "),a("li",[t._v("The total value for the funding amount")]),t._v(" "),a("li",[t._v("he marker and the miner fees")]),t._v(" "),a("li",[t._v("The limit on the quantity of utxos the daemon can take from the wallet of the user\n"),a("ul",[a("li",[t._v("Naturally, only utxos that are available via the wallet's private keys can be used for these inputs")])])])]),t._v(" "),a("h4",{attrs:{id:"adding-outputs-to-the-transaction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#adding-outputs-to-the-transaction"}},[t._v("#")]),t._v(" Adding Outputs to the Transaction")]),t._v(" "),a("p",[t._v("According to our specification, we need two outputs: one for the funding deposit and one for the marker.")]),t._v(" "),a("p",[t._v("Here, we use two CC SDK functions that are designed to create CC vouts.")]),t._v(" "),a("p",[t._v("In our first statement we use the "),a("code",[t._v("MakeCC1of2vout")]),t._v(" function to create a CC vout with a threshold of "),a("code",[t._v("2")]),t._v(" addresses that can spend from the plan funds.")]),t._v(" "),a("p",[t._v("We supply as arguments the two potential addresses, represented here as "),a("code",[t._v("myPubkey")]),t._v(" and "),a("code",[t._v("heirPubkey")]),t._v(". Therefore, there are two pubkeys that are able to spend funds in the address.")]),t._v(" "),a("p",[t._v("The statement of code then adds this vout to the transaction.")]),t._v(" "),a("p",[t._v("Note the eval code, "),a("code",[t._v("EVAL_HEIR")]),t._v(". This triggers the Heir validation code whenever an Heir Module transaction occurs.")]),t._v(" "),a("p",[t._v("The second statement creates a marker vout with a simple CryptoCondition.")]),t._v(" "),a("p",[t._v("We always need some kind of marker for any instance of an Antara Module plan for at least the initial transaction. Otherwise, we might lose the instance's data in the blockchain. We call this a "),a("b",[t._v("marker pattern")]),t._v(" in Antara development, and we will explore this concept in more detail later in the tutorial.")]),t._v(" "),a("p",[t._v("For now, we need to obtain the global CC address so that we can both mark the transaction, and to find all Heir funding plans. To obtain the global address we use the "),a("code",[t._v("GetUnspendable()")]),t._v(" function.")]),t._v(" "),a("p",[t._v("We use the "),a("code",[t._v("MakeCC1vout")]),t._v(" function to create a vout with a simple CryptoCondition that sends a transaction fee to the Heir Module global CC address.")]),t._v(" "),a("p",[t._v("The statement then adds this vout to the transaction. This vout will be used for retrieving the list of all instances of the Heir Module via the "),a("b",[t._v("heirlist")]),t._v(" RPC.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("        mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push_back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("MakeCC1of2vout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" myPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push_back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("MakeCC1vout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" txfee"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetUnspendable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Finish the creation of the transaction by calling the "),a("code",[t._v("FinalizeCCTx")]),t._v(" function along with its parameters from the "),a("code",[t._v("cp")]),t._v(" object, the "),a("code",[t._v("mtx")]),t._v(" object itself, the owner's pubkey, and the transaction fee amount.")]),t._v(" "),a("p",[t._v("Note the cast to "),a("code",[t._v("uint8_t")]),t._v(" for the constants "),a("code",[t._v("EVAL_HEIR")]),t._v(" and "),a("code",[t._v("F")]),t._v(" function id. This is important, as the cast supposes a one-byte size for the serialization of these values. If this size was not inferred, then the type would be an "),a("code",[t._v("int")]),t._v(".")]),t._v(" "),a("p",[t._v("Also, an opreturn object with the data from this module instance is passed. To create the opreturn object, serialize the needed ids and variables to a "),a("code",[t._v("CScript")]),t._v(" object.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("        std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("string rawhextx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FinalizeCCTx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" myPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" txfee"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CScript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" OP_RETURN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("EVAL_HEIR "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'F'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" myPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" heirPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" inactivityTimeSec "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" heirName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" rawhextx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("In case the "),a("code",[t._v("AddNormalinputs()")]),t._v(" function cannot find sufficient owner coins for the requested amount (including the transaction fee), we set the "),a("code",[t._v("CCerror")]),t._v(" error object.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    CCerror "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"not enough coins for requested amount and txfee"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Note that we do not need to add the normal change output here because the "),a("code",[t._v("FinalizeCCTx")]),t._v(" function adds the change output for us.")]),t._v(" "),a("p",[a("code",[t._v("FinalizeCCTx")]),t._v(" also builds the transaction input "),a("code",[t._v("scriptSigs")]),t._v(" (both normal and CC aspects), adds tx signatures to them, and returns a signed transaction in hexadecimal encoding.")]),t._v(" "),a("p",[t._v("Also note the "),a("code",[t._v("E_MARSHAL()")]),t._v(" function. This serializes variables of various supported types to a byte array. The byte array is then serialized to a "),a("code",[t._v("CScript")]),t._v(" object. The object is stored in the "),a("code",[t._v("scriptPubKey")]),t._v(" transaction field in the last opreturn vout with transaction data.")]),t._v(" "),a("p",[t._v("There is also the mirror "),a("code",[t._v("E_UNMARSHAL()")]),t._v(" function. This is used for unpacking opreturn data from a CScript object to C++ variables, and for further processing.")]),t._v(" "),a("p",[t._v("The returned transaction is ready to be sent to the Smart Chain network using the "),a("RouterLink",{attrs:{to:"/basic-docs/smart-chains/smart-chain-api/rawtransactions.html#sendrawtransaction"}},[a("b",[t._v("sendrawtransaction")])]),t._v(" RPC.")],1),t._v(" "),a("h4",{attrs:{id:"implementing-the-heirclaim-rpc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#implementing-the-heirclaim-rpc"}},[t._v("#")]),t._v(" Implementing the heirclaim RPC")]),t._v(" "),a("p",[t._v("As before, this implementation has two levels. The first level checks the required environment and converts the parameters. The second level creates the final transaction.")]),t._v(" "),a("h5",{attrs:{id:"heirclaim-syntax"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heirclaim-syntax"}},[t._v("#")]),t._v(" heirclaim syntax")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("./komodo-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-ac_name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("YOURCHAIN heirclaim fundingtxid amount\n")])])]),a("h5",{attrs:{id:"add-the-rpc-command-to-komodo-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-the-rpc-command-to-komodo-cli"}},[t._v("#")]),t._v(" Add the RPC command to komodo-cli")]),t._v(" "),a("p",[t._v("Add a new command to "),a("code",[t._v("komodo-cli")]),t._v(" by adding a new element into the "),a("code",[t._v("vRPCCommands")]),t._v(" array in the source file "),a("code",[t._v("src/server.cpp")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"heir"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"heirclaim"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("heirclaim"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),a("p",[t._v("Using the previous section of the tutorial as an example, add an "),a("code",[t._v("heirclaim")]),t._v(" RPC implementation in the "),a("code",[t._v("src/rpc/wallet.cpp")]),t._v(" source file.")]),t._v(" "),a("p",[t._v("Add the "),a("code",[t._v("heirclaim")]),t._v(" declaration in the "),a("code",[t._v("src/rpc/server.h")]),t._v(" header file.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// heirclaim command rpc-level implementation, src/wallet/rpcwallet.cpp")]),t._v("\n\nUniValue "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("heirclaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" UniValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" fHelp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    CCerror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clear")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// clear global error object")]),t._v("\n")])])]),a("p",[t._v("Check that the wallet is available.")]),t._v(" "),a("p",[t._v("In case the user asks for help via the "),a("code",[t._v("--help")]),t._v(" parameter, or in case the parameters are not correctly submitted, print a "),a("code",[t._v("help")]),t._v(" message to the console.")]),t._v(" "),a("p",[t._v("Also check that Antara requirements are satisfied:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("EnsureWalletIsAvailable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fHelp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" NullUniValue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fHelp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("runtime_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"heirclaim txfee funds fundingtxid\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ensure_CCrequirements")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("runtime_error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"to use Antara modules, you need to launch daemon with valid -pubkey= for an address in your wallet\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Lock the wallet:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LOCK2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cs_main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pwalletMain"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("cs_wallet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Convert the parameters from "),a("code",[t._v("UniValue")]),t._v(" to "),a("code",[t._v("c++")]),t._v(" type:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    uint256 fundingtxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Parseuint256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("c_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CAmount amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("atof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("c_str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" COIN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Note conversion from satoshis to coins by multiplication by 10E8")]),t._v("\n")])])]),a("p",[t._v("Call the "),a("code",[t._v("HeirClaim")]),t._v(" transaction creation function and return the created transaction in hexadecimal.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    UniValue result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HeirClaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("RETURN_IF_ERROR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CCerror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use a macro to throw runtime_error if CCerror is set in HeirFund()")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"transaction-creation-code-for-heirclaim-rpc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#transaction-creation-code-for-heirclaim-rpc"}},[t._v("#")]),t._v(" Transaction creation code for heirclaim RPC")]),t._v(" "),a("p",[t._v("Implement the "),a("code",[t._v("HeirClaim")]),t._v(" transaction creation code in the "),a("code",[t._v("src/cc/heir.cpp")]),t._v(" source file.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// heirclaim transaction creation function, src/cc/heir.cpp")]),t._v("\nstd"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("string "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HeirClaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uint256 fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("Start with creating a mutable transaction object:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    CMutableTransaction mtx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CreateNewContextualCMutableTransaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Params")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetConsensus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("komodo_nextheight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Initialize the "),a("code",[t._v("cp")]),t._v(" object:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CCcontract_info")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    cp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CCinit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Find the most recent owner transaction to calculate the owner's inactivity time. The helper function, "),a("code",[t._v("FindLatestOwnerTx()")]),t._v(", returns the latest transaction id, the "),a("code",[t._v("owner")]),t._v(" and "),a("code",[t._v("heir")]),t._v(" public keys, "),a("code",[t._v("inactivity time setting")]),t._v(" value, and the "),a("code",[t._v("hasHeirSpendingBegun")]),t._v(" flag value.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" txfee "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CPubKey ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" inactivityTimeSec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint256 latesttxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FindLatestOwnerTx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inactivityTimeSec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" latesttxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsNull")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        CCerror "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"no funding tx found"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Check whether the inactivity time of the owner has surpassed the amount designated in the plan. The "),a("code",[t._v("CCduration")]),t._v(" CC SDK function returns the time (in seconds) since the confirmation of the block that bears the provided transaction to the chain-tip block.")]),t._v(" "),a("p",[t._v("If "),a("code",[t._v("hasHeirSpendingBegun")]),t._v(" is already "),a("code",[t._v("true")]),t._v(", there is no need to also check the owner's inactivity time.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int32_t")]),t._v(" numBlocks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// not used")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" isAllowedToHeir "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hasHeirSpendingBegun "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CCduration")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("numBlocks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" latesttxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" inactivityTimeSec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    CPubKey myPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("pubkey2pk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Mypubkey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pubkey2pk sdk function converts pubkey from a byte array to CPubKey object")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" myPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" heirPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("isAllowedToHeir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        CCerror "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"spending funds is not allowed for heir yet"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Create the claim transaction inputs and outputs.")]),t._v(" "),a("p",[t._v("Add normal inputs for the transaction fee:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddNormalinputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" myPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" txfee"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" txfee"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        CCerror "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"not enough normal inputs for txfee"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Get the address of the "),a("code",[t._v("1of2")]),t._v(" threshold CryptoCondition output (where the funds were deposited). Add CC inputs for the requested amount.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("65")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetCCaddress1of2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Add CC inputs for this address with the use of a custom function:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" inputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add1of2AddressInputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" amount "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        CCerror "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"not enough funds claimed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Add a normal output to receive the claimed funds, and a CC change output for the remaining amount.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push_back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CTxOut")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CScript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ParseHex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HexStr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("myPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" OP_CHECKSIG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push_back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("MakeCC1of2vout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Add normal change (if any), add OP_RETURN data, and sign the transaction:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("     "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FinalizeCCTx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" myPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" txfee"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CScript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" OP_RETURN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("E_MARSHAL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("EVAL_HEIR "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'C'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" fundingtxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("myPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" heirPubkey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("In the opreturn we add a pair of standard ids: the CC "),a("code",[t._v("EVAL")]),t._v(" code, the functional id, and the "),a("code",[t._v("fundingtxid")]),t._v(" to serve as the funding plan identifier.")]),t._v(" "),a("p",[t._v("The "),a("code",[t._v("hasHeirSpendingBegun")]),t._v(" value is a special flag. When this value is changed to "),a("code",[t._v("1")]),t._v(", it indicates that the heir has spent funds in the fund at least once. Therefore, it is no longer necessary to check the inactivity time of the owner.")]),t._v(" "),a("p",[t._v("Once "),a("code",[t._v("hasHeirSpendingBegun")]),t._v(" is set to "),a("code",[t._v("true")]),t._v(", this flag should also be set to "),a("code",[t._v("true")]),t._v(" in the following transaction OP_RETURN values.")]),t._v(" "),a("h4",{attrs:{id:"implementations-for-heiradd-heirlist-and-heirinfo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#implementations-for-heiradd-heirlist-and-heirinfo"}},[t._v("#")]),t._v(" Implementations for heiradd, heirlist and heirinfo")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("heiradd")]),t._v(" allows a user to add more funding to a plan.")]),t._v(" "),a("li",[a("code",[t._v("heirlist")]),t._v(" is a standard RPC for all CC modules. This RPC outputs a list of all initial transaction IDs, which serve as the identifiers for each plan.")]),t._v(" "),a("li",[a("code",[t._v("heirinfo")]),t._v(" provides data about a funding plan.")])]),t._v(" "),a("p",[t._v("The implementation for these RPCs can be found in the github repository with the source code of this contract.")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/dimxy/komodo/blob/heir-simple/src/wallet/rpcwallet.cpp",target:"_blank",rel:"noopener noreferrer"}},[t._v("RPC implementation can be found here."),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/dimxy/komodo/blob/heir-simple/src/cc/heir.cpp",target:"_blank",rel:"noopener noreferrer"}},[t._v("Transaction creation and retrieval code can be found here."),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"heir-module-helper-functions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heir-module-helper-functions"}},[t._v("#")]),t._v(" Heir Module Helper Functions")]),t._v(" "),a("h4",{attrs:{id:"simplified-add1of2addressinputs-function-implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#simplified-add1of2addressinputs-function-implementation"}},[t._v("#")]),t._v(" Simplified Add1of2AddressInputs() Function Implementation")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// add inputs from cc threshold=2 cryptocondition address to transaction object, src/cc/heir.cpp")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add1of2AddressInputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CMutableTransaction "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uint256 fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" amount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int32_t")]),t._v(" maxinputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" totalinputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0L")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int32_t")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("By default, the CC SDK function, "),a("code",[t._v("SetCCunspents")]),t._v(", fills the provider vector with a list of unspent cc outputs of the provided "),a("code",[t._v("coinaddr")]),t._v(" Bitcoin address.")]),t._v(" "),a("p",[t._v("For our Heir Module, we pass the "),a("code",[t._v("1of2")]),t._v(" address where the plan's funds are stored.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("pair"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CAddressUnspentKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CAddressUnspentValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetCCunspents")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// get a vector of cc uxtos for the address in coinaddr[]")]),t._v("\n")])])]),a("p",[t._v("Iterate through the returned uxtos and add those that are appropriate to the transaction's vin array:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("pair"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CAddressUnspentKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CAddressUnspentValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("const_iterator it "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" it "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         CTransaction tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n         uint256 hashBlock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n         std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Load the current uxto's transaction and check whether it has an opreturn in the back of the array of outputs.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetTransaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("txhash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hashBlock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetOpReturnData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scriptPubKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" evalCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n              uint256 txid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Check that the uxto matches this plan.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("              "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("txhash "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" fundingtxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// if this is our contract instance coins")]),t._v("\n                  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("E_UNMARSHAL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" evalCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" txid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// unserialize opreturn")]),t._v("\n                  fundingtxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" txid  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// it is a tx from this funding plan")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("To add the utxo to the transaction's vins, set the utxo's vout number and transaction id in the transactions vins. Pass an empty call to the "),a("code",[t._v("CScript()")]),t._v(" function in the "),a("code",[t._v("scriptSig")]),t._v(" parameter. This will be filled by the "),a("code",[t._v("FinalizeCCtx")]),t._v(" function.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("                  mtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push_back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CTxIn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("txhash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CScript")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                  totalinputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("second"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("satoshis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Stop once sufficient CC inputs are found.")]),t._v(" "),a("p",[t._v("In the event that the "),a("code",[t._v("amount")]),t._v(" parameter is "),a("code",[t._v("0")]),t._v(", add all available inputs to calculate all available funds.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("                  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" totalinputs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" amount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" maxinputs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Return the total amount of inputs added to the transaction's vin array:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" totalinputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"simplified-implementation-of-the-findlatestownertx-function"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#simplified-implementation-of-the-findlatestownertx-function"}},[t._v("#")]),t._v(" Simplified Implementation of the FindLatestOwnerTx() Function")]),t._v(" "),a("p",[t._v("To calculate the owner-inactivity time and to enable the heir to claim the funds, we implement the function, "),a("code",[t._v("FindLatestOwnerTx()")]),t._v(".")]),t._v(" "),a("p",[t._v("This function iterates through the transactions of this plan, (which we can also call this instance of the Heir Module) and finds the owner's latest transaction. We pass into this function the initial funding txid of the plan we desire to inspect.")]),t._v(" "),a("p",[t._v("The function returns the pubkeys of both the owner and the heir, the owner inactivity time, and a flag that indicates whether the heir has already spent funds from the "),a("code",[t._v("1of2")]),t._v(" address.")]),t._v(" "),a("p",[t._v("All returned values of the function are retrieved from the transactions' opreturns.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// find the latest owner transaction id")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this function also returns some values from the initial and latest transaction opreturns")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Note: this function is also called from validation code (use non-locking calls)")]),t._v("\n\nuint256 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FindLatestOwnerTx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uint256 fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CPubKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CPubKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" inactivityTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Initialize the flag as though the heir has not yet spent any of their plan's funds.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    hasHeirSpendingBegun "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Initialize the following variables.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    CTransaction fundingtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint256 hashBlock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("string name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Load the initial funding transaction, check whether it has a correct opreturn, and de-serialize it.")]),t._v(" "),a("p",[t._v("Check the transaction rules. Return an empty id if the funding transaction cannot not be loaded or is incorrect.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("myGetTransaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fundingtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hashBlock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// NOTE: use non-locking version of GetTransaction as we may be called from validation code")]),t._v("\n        fundingtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// no vouts, even opreturn")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetOpReturnData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fundingtx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scriptPubKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// could not get opreturn from the last vout")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("E_UNMARSHAL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" inactivityTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// could not unmarshal opreturn")]),t._v("\n        eval "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" EVAL_HEIR "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// incorrect eval code in 1st byte")]),t._v("\n        funcId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'F'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// incorrect funcid in the 2nd byte")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" zeroid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Initialize the CC contract object for the Heir Module's "),a("code",[t._v("EVAL")]),t._v(" code.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CCcontract_info")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    cp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CCinit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EVAL_HEIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Declare the "),a("code",[t._v("coinaddr")]),t._v(" array and use the "),a("code",[t._v("GetCCaddress1of2")]),t._v(" function to pass the array the "),a("code",[t._v("1of2")]),t._v(" address that holds our funds.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetCCaddress1of2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Get the vector with uxtos for the "),a("code",[t._v("1of2")]),t._v(" address.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("pair"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CAddressUnspentKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CAddressUnspentValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetCCunspents")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" coinaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Iterate through the returned uxto's to find the last funding or spending owner transaction:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int32_t")]),t._v(" maxBlockHeight "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint256 latesttxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// set to initial txid")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("pair"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("CAddressUnspentKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CAddressUnspentValue"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("const_iterator it "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" it "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" unspentOutputs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        CTransaction vintx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        uint256 blockHash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" flagopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        uint256 txidopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int32_t")]),t._v(" blockHeight "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int32_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("second"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("blockHeight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Retrieve the transaction from the returned array. Check and unmarshal the transaction's opreturn and check whether this transaction is from the relevant Heir plan.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("myGetTransaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("txhash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vintx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" blockHash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// NOTE: use non-locking version of GetTransaction as we may be called from validation code")]),t._v("\n            vintx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetOpReturnData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vintx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scriptPubKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("E_UNMARSHAL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" txidopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" flagopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n            eval "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" EVAL_HEIR "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("funcId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'C'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" funcId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'A'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n            fundingtxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" txidopret "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("As the "),a("code",[t._v("SetCCunspents")]),t._v(" function does not return uxtos in chronological order, order them by block height to find the latest utxo.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("blockHeight "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" maxBlockHeight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("Check whether this transaction indicates owner activity. Use a pair of CC SDK functions, "),a("code",[t._v("TotalPubkeyNormalInputs()")]),t._v(" and "),a("code",[t._v("TotalPubkeyCCInputs()")]),t._v(", that iterate through the vin array to find if the transaction was signed with the owner's pubkey.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("TotalPubkeyNormalInputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vintx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("TotalPubkeyCCInputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vintx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("If this transaction represents owner activity, reset the latest txid to this current txid.")]),t._v(" "),a("p",[t._v("Set the flag for the transaction opreturn.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("                    latesttxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" it"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("txhash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t    hasHeirSpendingBegun "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" flagopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    maxBlockHeight "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" blockHeight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Return the latest owner txid.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" latesttxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"heir-module-validation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heir-module-validation"}},[t._v("#")]),t._v(" Heir Module Validation")]),t._v(" "),a("h4",{attrs:{id:"simplified-validation-function-implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#simplified-validation-function-implementation"}},[t._v("#")]),t._v(" Simplified Validation Function Implementation")]),t._v(" "),a("p",[t._v("Validation provides the logic control of spent Antara-module value, and validation also provides the data added to the Smart Chain.")]),t._v(" "),a("p",[t._v("Recall that validation code is invoked for a transaction at the time the CC-related value is spent (as opposed to only being invoked at the time the value is added). We trigger the invocation of this validation function when at least one transaction input is a CC input bearing this module's "),a("code",[t._v("EVAL")]),t._v(" code.")]),t._v(" "),a("p",[t._v("Validation code typically is not called for the Antara module's initial transaction. Instead, we invoke validatation at the time the initial transaction is spent in a second transaction.")]),t._v(" "),a("p",[t._v("One way to invoke validation for the first transaction when performing the second transaction is to load the initial transaction and validate it first. If the initial transaction turns out to be invalid, it can remain in the chain and is otherwise ignored. In this case, if a CC marker is used, it can be cleared and the transaction is removed from the initial transaction list RPC output.")]),t._v(" "),a("h4",{attrs:{id:"guidelines-for-validation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#guidelines-for-validation"}},[t._v("#")]),t._v(" Guidelines for Validation")]),t._v(" "),a("p",[t._v("In our Heir Module prototype, we have three transactions to validate: the initial funding, the adding transaction that adds more funds, and the transaction that claims the funds. The first and second of these transactions do not have any CC vins, and therefore all are validated together with the transaction that claims the funds.")]),t._v(" "),a("p",[t._v("Here are several common aspects of a module that require validation:")]),t._v(" "),a("ul",[a("li",[t._v("The basic transaction structure")]),t._v(" "),a("li",[t._v("The basic data structure in the OP_RETURN\n"),a("ul",[a("li",[t._v("Validation here ensures data integrity in the chain")]),t._v(" "),a("li",[t._v("All OP_RETURNs should contain the "),a("code",[t._v("EVAL")]),t._v(" code and functional id in the first two bytes")])])]),t._v(" "),a("li",[t._v("Avoid all foreseeable attack vectors\n"),a("ul",[a("li",[t._v("Ensure DOS attacks are eliminated, especially in the event of a malformed transaction")]),t._v(" "),a("li",[t._v("Check the array size before use of any transaction data")])])]),t._v(" "),a("li",[t._v("Check the previous Heir Module transactions which this transaction spends and which have no cc inputs. This is accomplished by retrieving the transaction id from the opreturn and loading and validating the previous transaction")])]),t._v(" "),a("h4",{attrs:{id:"heir-module-validation-rules"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heir-module-validation-rules"}},[t._v("#")]),t._v(" Heir Module Validation Rules")]),t._v(" "),a("p",[t._v("The following are the aspects of validation the Heir Module requires.")]),t._v(" "),a("ul",[a("li",[t._v("The initial funding transaction\n"),a("ul",[a("li",[t._v("Validate that the "),a("code",[t._v("1of2")]),t._v(" address accurately matches "),a("code",[t._v("pubkeys")]),t._v(" in the opreturn")])])]),t._v(" "),a("li",[t._v("The claiming transaction\n"),a("ul",[a("li",[t._v("Validate that this transaction spends transactions from the same funding plan. This funding transaction id's values from the opreturn outputs of the previous transactions should match. (the previous transactions are often referred as "),a("code",[t._v("vintx")]),t._v(" in code)")])])]),t._v(" "),a("li",[t._v("Validate whether the heir is allowed to spend the funds\n"),a("ul",[a("li",[t._v("Check whether the flag indicates that the Heir is already spending the funds")]),t._v(" "),a("li",[t._v("Check whether enough time has passed since the last time the owner was active on the chain")])])]),t._v(" "),a("li",[t._v("When validating, separate the owner's funding transaction from any other contributions to the "),a("code",[t._v("1of2")]),t._v(" address\n"),a("ul",[a("li",[t._v("Although the Heir Module is initiated based on the owner's initial transaction, nothing prevents other users on the Smart Chain from contributing funds")]),t._v(" "),a("li",[t._v("Therefore, when validating, for each utxo contained in the "),a("code",[t._v("1of2")]),t._v(" address, calculate whether or not the utxo's vins contain the owner's pubkey")])])]),t._v(" "),a("li",[t._v("During the course of validation, we fully check opreturn format")])]),t._v(" "),a("p",[t._v("This validation logic is performed in the "),a("code",[t._v("HeirValidate()")]),t._v(" function. The function is invoked whenever a CC transaction bearing the appropriate eval code occurs on the chain. When this eval code appears, the consensus mechanism calls the "),a("code",[t._v("HeirValidate()")]),t._v(" function, executes the indicated validation code, and adds the transaction to the chain.")]),t._v(" "),a("h4",{attrs:{id:"heirvalidate-implementation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#heirvalidate-implementation"}},[t._v("#")]),t._v(" HeirValidate() Implementation")]),t._v(" "),a("p",[t._v("Explanation of code:")]),t._v(" "),a("ul",[a("li",[t._v("Transaction-validation entry function\n"),a("ul",[a("li",[t._v("(This is actually a callback)")])])]),t._v(" "),a("li",[t._v("Parameters\n"),a("ul",[a("li",[a("code",[t._v("cpHeir")]),t._v(" - Pointer to the module's variable structure")]),t._v(" "),a("li",[a("code",[t._v("eval")]),t._v(" - Pointer to the CC dispatching object\n"),a("ul",[a("li",[t._v("Used to return invalid state")])])]),t._v(" "),a("li",[a("code",[t._v("tx")]),t._v(" - The transaction itself")]),t._v(" "),a("li",[a("code",[t._v("nIn")]),t._v(" - Not used in validation code")])])])]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HeirValidate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CCcontract_info")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" cpHeir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" CTransaction"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint32_t")]),t._v(" nIn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("Check that the basic transaction structure has the opreturn with the correct basic "),a("code",[t._v("evalcode")]),t._v(" and "),a("code",[t._v("funcid")]),t._v(".")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("There is no need to check the function ids of the ("),a("code",[t._v("F")]),t._v(") funding transaction or the ("),a("code",[t._v("A")]),t._v(") add transaction, as these transactions have no Heir CC vins. Therefore, we do not create validation code for them.")])]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("vector "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetOpReturnData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("back")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scriptPubKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" EVAL_HEIR "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n        vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'C'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// interrupt the validation and return invalid state:")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Invalid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"incorrect or no opreturn data"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// note that you should not return simply 'false'")]),t._v("\n")])])]),a("p",[t._v("Decode the transaction's opreturn with the "),a("code",[t._v("E_UNMARSHAL")]),t._v(" function. This function places the opreturn serialized data into several variables. One of them, the "),a("code",[t._v("fundingtxid")]),t._v(" variable, is the transaction id (txid) of the initial funding transaction. We will use it further to find the latest owner transaction to check when the owner was last active on the chain.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" evalcode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint256 fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//initialized to null")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("E_UNMARSHAL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vopret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" evalcode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// return invalid state if unserializing function returned false:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Invalid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"incorrect opreturn data"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Check that the "),a("code",[t._v("fundingtxid")]),t._v(" is a valid txid:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsNull")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Invalid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"incorrect funding plan id in tx opret"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Here we come to a good place to load the initial transaction, check whether it exists, and whether it has a correctly formed opreturn.")]),t._v(" "),a("p",[t._v("Call the "),a("code",[t._v("FindLatestOwnerTx()")]),t._v(" function. This function obtains the opreturn parameters and the "),a("code",[t._v("hasHeirSpendingBegun")]),t._v(" flag, and checks the initial transaction.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    CPubKey ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int64_t")]),t._v(" inactivityTimeSec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uint8_t")]),t._v(" lastHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    uint256 latesttxid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FindLatestOwnerTx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ownerPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inactivityTimeSec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lastHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("latesttxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsNull")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Invalid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"no or incorrect funding tx found"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Print a log message to the console that the daemon process is in the validation code:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("cerr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"HeirValidate funcid="')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("funcId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('" evalcode="')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("cpHeir"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("evalcode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("endl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Prepare for validation rules that are specific for each function id ("),a("code",[t._v("F")]),t._v(", "),a("code",[t._v("A")]),t._v(", and "),a("code",[t._v("C")]),t._v(").")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])])]),a("p",[t._v("For "),a("code",[t._v("F")]),t._v(" and "),a("code",[t._v("A")]),t._v(", we return an invalid response, as the process should never be able to access these function ids.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'F'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'A'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Invalid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unexpected HeirValidate for heirfund"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Validation for the claiming transaction.")]),t._v(" "),a("ul",[a("li",[t._v("Check whether we are spending the correct funding transactions\n"),a("ul",[a("li",[t._v("For example, check that the transactions are from the correct module instance, as identified by the "),a("code",[t._v("fundingtxid")])]),t._v(" "),a("li",[t._v("If incorrect, return "),a("code",[t._v("false")])])])]),t._v(" "),a("li",[t._v("If the heir is claiming the funds, check that he is allowed to do so\n"),a("ul",[a("li",[t._v("For example, check the inactivity time of the owner and whether the heir has already spent funds from the "),a("code",[t._v("1of2")]),t._v(" address")])])]),t._v(" "),a("li",[t._v("Check whether the new flag, "),a("code",[t._v("hasHeirSpendingBegun")]),t._v(", is set correctly")])]),t._v(" "),a("p",[t._v("Both of the following support functions, "),a("code",[t._v("CheckSpentTxns")]),t._v(" and "),a("code",[t._v("CheckInactivityTime")]),t._v(", are in the "),a("code",[t._v("heir.cpp")]),t._v(" source file.")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/dimxy/komodo/blob/heir-simple/src/cc/heir.cpp",target:"_blank",rel:"noopener noreferrer"}},[t._v("Link to heir.cpp source file"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[t._v("'C'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CheckSpentTxns")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cpHeir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fundingtxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CheckInactivityTime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cpHeir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" latesttxid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inactivityTimeSec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" heirPubkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lastHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hasHeirSpendingBegun"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("For unsupported function ids, return an invalid state.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("cerr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"HeirValidate() illegal heir funcid="')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("funcId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" std"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),t._v("endl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Invalid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unexpected HeirValidate funcid"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("If all rules pass, return a valid state.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" eval"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Valid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"validation-code-errors"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#validation-code-errors"}},[t._v("#")]),t._v(" Validation Code Errors")]),t._v(" "),a("p",[t._v("During the development of validation code, you will likely receive validation errors when any CC module validation function returns an invalid state.")]),t._v(" "),a("p",[t._v("For example, when sending a raw transaction, the daemon checks the transaction while adding it to the mempool.")]),t._v(" "),a("p",[t._v("During this process, if the CC validation code returns an invalid state you will see the following error:")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("error code"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v("\nerror message"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" mandatory"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("verify"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("flag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("failed")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Script evaluated without error but finished with a "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("empty top stack element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("When this happens, check the server output for a more specific error description. The first line of the output contains the "),a("code",[t._v("eval->invalid()")]),t._v(" message from your validation code.")]),t._v(" "),a("div",{staticClass:"language-cpp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("CC Eval EVAL_HEIR Invalid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" incorrect opreturn data spending tx "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("b6e1ed868cf941dabf9edc7f675321bdb4258692ba02f56dc21100f88981ac4\nERROR"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CScriptCheck")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7961f")]),t._v("e4f9f3bdabef154404ea8ec7a11be1546febc34efe67faede8d930c0749"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" VerifySignature failed"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Script evaluated without error but finished with a "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("empty top stack element\nERROR"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" AcceptToMemoryPool"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" BUG"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" PLEASE REPORT THIS"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" ConnectInputs failed against MANDATORY but "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("not")]),t._v(" STANDARD flags "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7961f")]),t._v("e4f9f3bdabef154404ea8ec7a11be1546febc34efe67faede8d930c0749\n")])])]),a("hr"),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/basic-docs/antara/antara-tutorials/advanced-series-6.html"}},[a("b",[t._v("Link to Next Tutorial in Advanced Series")])])],1)])}),[],!1,null,null,null);a.default=e.exports}}]);